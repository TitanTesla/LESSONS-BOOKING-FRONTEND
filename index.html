<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vue.js Lessons App</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .lesson {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        width: 30%;
      }
      .form-group {
        margin-bottom: 10px;
      }
      button {
        padding: 8px 16px;
        margin-top: 10px;
      }
      header,
      header > button,
      header > label {
        padding: 10px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header>
        <h1>{{ sitename }}</h1>
        <button v-on:click="toggleCheckout" :disabled="cartItemCount === 0">
          {{ cartItemCount }} <span class="fas fa-cart-plus"></span> View Cart
        </button>
        <div>
          <label for="sort">Sort by:</label>
          <select v-model="sortAttribute" id="sort">
            <option value="subject">Subject</option>
            <option value="location">Location</option>
            <option value="price">Price</option>
            <option value="spaces">Spaces</option>
          </select>
          <label for="order">Order:</label>
          <select v-model="sortOrder" id="order">
            <option value="ascending">Ascending</option>
            <option value="descending">Descending</option>
          </select>
        </div>
      </header>
      <main v-if="!showCheckout">
        <div v-for="lesson in sortedLessons" :key="lesson._id" class="lesson">
          <img
            :src="`https://lessons-booking-backend-hr3a.onrender.com/images/${lesson.image}`"
            alt="Lesson Image"
            style="width: 100%; height: auto"
          />
          <h2>{{ lesson.subject }}</h2>
          <p>Location: {{ lesson.location }}</p>
          <p>Price: ${{ lesson.price }}</p>
          <p>Spaces Available: {{ lesson.spaces }}</p>
          <button v-on:click="addToCart(lesson)" :disabled="lesson.spaces <= 0">
            Add to Cart
          </button>
        </div>
      </main>
      <div v-if="showCheckout">
        <h2>Your Cart</h2>
        <div v-for="(lesson, index) in cart" :key="lesson._id" class="cart-item">
          <p><strong>Subject:</strong> {{ lesson.subject }}</p>
          <p><strong>Location:</strong> {{ lesson.location }}</p>
          <p><strong>Price:</strong> ${{ lesson.price }}</p>
          <button v-on:click="removeFromCart(index)">Remove</button>
        </div>
        <button v-on:click="toggleCheckout">Close Cart</button>
        <h2>Checkout</h2>
        <div class="form-group">
          <label for="name">Name:</label>
          <input
            v-model="order.name"
            id="name"
            type="text"
            placeholder="Your Name"
            @input="validateInputs"
          />
        </div>
        <div class="form-group">
          <label for="phone">Phone:</label>
          <input
            v-model="order.phone"
            id="phone"
            type="text"
            placeholder="Your Phone"
            @input="validateInputs"
          />
        </div>
        <button v-on:click="submitOrder" :disabled="!isFormValid">
          Submit Order
        </button>
      </div>
    </div>
    <script>
      new Vue({
        el: '#app',
        data: {
          sitename: 'Lessons Booking App',
          lessons: [],
          cart: [],
          showCheckout: false,
          order: { name: '', phone: '' },
          isFormValid: false,
          sortAttribute: 'subject',
          sortOrder: 'ascending',
        },
        computed: {
          cartItemCount() {
            return this.cart.length;
          },
          sortedLessons() {
            let sorted = [...this.lessons].sort((a, b) => {
              if (this.sortAttribute === 'price' || this.sortAttribute === 'spaces') {
                return a[this.sortAttribute] - b[this.sortAttribute];
              }
              return a[this.sortAttribute].localeCompare(b[this.sortAttribute]);
            });
            if (this.sortOrder === 'descending') {
              sorted.reverse();
            }
            return sorted;
          },
        },
        methods: {
          async fetchLessons() {
            const response = await fetch('https://lessons-booking-backend-hr3a.onrender.com/lessons');
            this.lessons = await response.json();
          },
          addToCart(lesson) {
            const cartItem = this.cart.find((item) => item._id === lesson._id);
            if (lesson.spaces > 0) {
              if (cartItem) {
                cartItem.spaces += 1;
              } else {
                this.cart.push({ ...lesson, originalSpaces: lesson.spaces, spaces: 1 });
              }
              lesson.spaces--;
            }
          },
          removeFromCart(index) {
            const cartItem = this.cart[index];
            const lesson = this.lessons.find((item) => item._id === cartItem._id);
            if (lesson) {
              lesson.spaces += cartItem.spaces;
            }
            this.cart.splice(index, 1);
          },
          toggleCheckout() {
            if (this.showCheckout) {
              this.cart.forEach((cartItem) => {
                const lesson = this.lessons.find((item) => item._id === cartItem._id);
                if (lesson) {
                  lesson.spaces = cartItem.originalSpaces;
                }
              });
              this.cart = [];
            }
            this.showCheckout = !this.showCheckout;
          },
          validateInputs() {
            const namePattern = /^[A-Za-z\s]+$/;
            const phonePattern = /^\+971\d{9}$/;

            const isNameValid = namePattern.test(this.order.name);
            const phoneInput = this.order.phone;

            if (phoneInput.length >= 4 && !phoneInput.startsWith('+971')) {
              this.isFormValid = false;
              return;
            }

            const digitsAfterPrefix = phoneInput.slice(4);
            if (digitsAfterPrefix.length > 9) {
              this.isFormValid = false;
              return;
            }

            this.isFormValid = isNameValid && phonePattern.test(phoneInput);
          },
          async submitOrder() {
            if (this.isFormValid) {
              const orderData = {
                name: this.order.name,
                phone: this.order.phone,
                lessons: this.cart.map((item) => ({
                  lessonId: item._id,
                  spaces: item.spaces,
                })),
              };

              await fetch('https://lessons-booking-backend-hr3a.onrender.com/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
              });

              alert('Order Submitted!');
              this.cart = [];
              this.order.name = '';
              this.order.phone = '';
              this.showCheckout = false;
              await this.fetchLessons();
            } else {
              alert('Please provide valid information.');
            }
          },
        },
        created() {
          this.fetchLessons();
        },
      });
    </script>
  </body>
</html>
